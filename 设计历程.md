

## 09/17

- 测试了一下原作和本作的地图差异，得到一些数据
	- 原作前置的景色一般要放大5倍
	- 后置的背景也要放大2倍
	- 原作的窗口大概是长1510，宽840，或许有更精确的数值比，但影响不大
	- 如何实现这一放大呢？
		- 相机肯定不行，主要靠tilelayer自己
		- 直接放大TileLayer即可
	- 注意到原作地图分为三层，这里命名为【背景层】【内层】【外层】
	- 同时，内外层还有一个描边。将单独的一块地形用黑色描边。这要如何实现呢？
		- 直接对其整体描边可以吗？测试一下
			- 不行
			- 因为原有的outline是基于sprite2d的texture属性进行的，肯定不能直接用来这里啊！
		- 找到一个类似的属性进行操作即可。但现有水平不够，暂时不能解决这个问题。
		- 问大佬去了
	- 内层地图相较于外层地图，有一个虚化的着色器就行
		- 调节了他的透明度，近似达到了原作的效果，暂时如此即可
	- 背景地图似乎是一个视差背景图，到时候再研究吧

## 09/18

- 在JACKADUX大佬的帮助下，解决了给tilemaplayer描边的问题
	- 给tilemap一个CanvasGroup的父节点，然后抄一个专门给CanvasGroup描边的着色器就好了
- 似乎景色放大倍数大了一点点，到时候再调吧
- 思考一下视差背景怎么做
	- 不知道滚动什么的咋用，暂时先这样吧
- 做了一个测试用的戴夫，用来看看风景
- 思考寻路和特殊地形：水/梯子
	- 用了一个shader来实现水的动画，但他变化的太快了，不知道咋改啊
	- 这可能又需要问问大佬们了
	- 搞定，但效果不好，可能还得用动画，但是，这样没有随机性啊？？？

## 09/19

- 今天继续观察寻路和水的效果，以及看看tilemap要放大几倍才好
	- 内外层的tilemap调整为放大4.62倍，不喜欢非整数倍，但也没什么办法
	- 戴夫放大4倍，且图层位于地图之后
- 准备做寻路相关事宜
	- 基本思路已经搞好
		- 但是，“水”的地形还没搞好
	- 具体思路是
		- 导入两个TileMapLayer变量，分别是【外部地图】【水地图】
		- 分别依据两个地图生成各种点
			- 参考B站那个视频，额外需要设计“水”中的点
		- 使用AStar2D来连接各种点，但没有什么“横跳”的线
			- 担心僵尸会走回头路，得想一想怎么跳过一些点
			- 或者是经过一些点后判断要不要删除或重新寻路？
		- 僵尸脚本处理这些点，向上就跳，这里没有跳跃能力的说法，僵尸也不会找梯子

## 09/23

- 这几天解决了“水”的视觉效果
	- “水”的物理效果不是很有思路，目前的想法是通过Area2D来让实体知道进入了水之中
	- 但是，如何是实体上下浮动呢？且在水覆盖后上浮呢？
	- 注意，刚进入水时速度要几乎0，开始重新计算

- 开始写戴夫的移动代码
	- 注意，僵尸的移动绝绝绝大部分和戴夫是一致的，可以先在戴夫这测试测试，再移植到僵尸上
	- 暂时不引入“状态机”，尽可能把代码功能写出来，再来搞状态机
	- 目前的问题
		- 希望戴夫靠墙时无法倾斜
		- 二段跳时的旋转不知道咋搞
		- 其他的细节

- 暂时先这样，加油干，这周把移动基本干好，国庆肯定可以搞定寻路

## 09/24

- 早上：
	- 把旋转加前移实现了，但一些细节处理的不好，还需要重构一次
- 晚上：
	- 感觉横向移动+跳跃干的还不错，并且也把基本函数抽象出来了
	- 似乎不错，之后再看看有什么要改动的吧，特别是一些参数
	- 像素抖动、起步与原作不同且不协调
		- 抖动已OK——开启物理插值即可
		- 还需要调整一下【下落速度】
		- 以及把各个参数抽象出来，为普通僵尸什么的创造条件

## 09/25

- 今天把梯子效果实现一下看看
	- 具体效果
		- 代替跳跃
		- 跳跃数刷新
		- 自动变化
		- 处于梯子状态时，横移不会产生大的偏移且速度有限
	- 要求
		- 一是梯子代替跳跃以及其他逻辑
		- 二是梯子的自动变化（三端变化，最好写个检测出来）
		- 三是对状态机和单独的移动函数的思考
	- 目前
		- 不好给他们自动化，我的想法是地图更改特别是梯子有破坏或新建时才有一个判断，但基础已经打好了
		- 需要整理一下目前的文件架构了，不然之后会更乱
		- 注意，cast需要开启hit_from_inside属性才可以检测全部的区域而不是一个点，以及检测的是area还是body
		- 今天的成果就是实现了梯子的效果，但动画部分需要等到可破坏地形后才好处理，并且需要知道如何判断有没有梯子（或许应该交给梯子tilemap解决）

## 09/26

- 明确了场景合集对于TilemapLayer的意义
- 重构梯子Layer
	- 实现了梯子自动变换，之后有场景破坏后再调动函数即可
- 重构水的场景结构
	- 视觉上，发现有重影bug
	- 物理还是没有大的思路，明早再做
- 注意，粒子是有碰撞的，会与world层/water碰撞
- 注意，僵尸的头、身子和头盔等都会沉到水里
- 注意，僵尸攻击后不可主动移动一段时间（在梯子上为掉下来一段距离）
- 准备了一个move节点，打算开始把移动脚本脱离主脚本

## 09/27

- 优化了梯子代码
	- 一是利用了local_to_map函数，这要求我们先找梯子，由梯子即可知道坐标cell，而不是反过来
	- 二是使用了child_order_changed信号，现在不需要额外的信号来提醒LadderLayer变化梯子动画了
- 解决了“水”的重叠！
	— 伟大的CanvasGroup！
- “水”的物理效果还是没有成功
	- 成功找到了top-water
	- 漂浮有点小问题，特别是刚开始的处理（高速进入水中）
	- 同时，在“水”中，刚开始是不能跳跃的，这个效果不好实现
	- 我觉得是时候引入状态概念了
		- 进入水时速度骤降且不可跳跃
		- 进入水时需要到达漂浮的最低点后才可以跳跃
		- 之后正常漂浮移动
		- 或许这个漂浮就是在最低点“小跳”罢了

## 09/28

- 昨天的思路很准确，水的物理就类似于平台上的小跳
- Move模块实现：把戴夫的移动代码迁移到了move上
- 关于气球
	- 感觉是时候引入状态机了
- 修复在水中同时有梯子时可以跳跃的bug，修复在水中第一次触底前可以攀爬的bug

## 09/29

- 今天主要解决了很多粒子问题，但都不在这个项目里面
- 把移动代码的导出变量等重新组织了一下，但还有一些工作没有完成
	- 为寻路做准备，我们需要把一些方法单独抽出来，给其变量就能移动（完成情况未知）
	- 气球还没有做，冰冻等状态对其的影响也没有涉及
	- 状态机是必备的，只是要到第几层的问题

## 09/29

- 粒子系统的技术难题都搞定了！
	- 现在有两条路线，一是用shader读取图片颜色，二是用代码设置其颜色
	- 其他都一样，之后的使用都需要调用其发射函数来实现向两边发射的效果
	- 但这个函数还没写，之后再干吧
- 看了一下，基本可以作为寻路的底子了，但其他的状态不晓得咋设计……需要总结一下才好操作

## 09/30 (前几天一定有一天重复了)

- 移动：戴夫碰撞体和图像位置调整
	- 把戴夫的图像和碰撞体都移动到(0,0)上面了，这是为了寻路时好对齐点位
- 粒子：基本函数完成，但还没有移植到这边来
	- 函数已经能用了，不过有一些细节问题
	- 一是应用时应该是实体自带发射器，那就需要获取图像，这一点还没写进函数中
	- 二是速度的曲线和随机度不够，目前暴露的参数不足以模拟原作的散步情况
	- 一些参数
		- 子弹粒子数：4
- 僵尸：新建文件夹，准备做抛掷体
	- 可以用贝塞尔曲线，但怎么操作呢？
	- 以及改了一些命名，让戴夫转正
- 寻路准备
	- 核心：找点连线、按点寻路
	- 注意：
		- 梯子本身不参与寻路，只是僵尸可以攀爬
		- 玩家本身作为一个点参与寻路，当玩家在平台上空时，僵尸会聚集在下面并进行尝试跳跃
		- 有些时候僵尸会在下面徘徊，尝试复刻这一效果
	- 同时，有些效果与寻路无关，和移动有关，需要注意
		- 僵尸叠罗汉
	- 一个疑问：是否只需要简单的点就好了，没必要搞这么多类呢？
		- 特别是一些点的意义不明，这需要好好考虑一下
		- 再看一遍寻路教程吧
	- 以及“水”和常规平台的兼容不太好搞……

## 10/01

- 寻路：左右边缘点已生成，但下坠点有bug
	- 怀疑是tilemap的缩放问题，可能需要改缩放为整数，或者是取消缩放，改为调整相机
	- 继续思考“水”中的寻路问题，目前的想法是当进入水中时单独处理相关逻辑
- 移动：参数调整
	- 导出旋转一圈的时间的变量并改为0.3s
	- 水中下落速度由200改为180
- 地图：尝试重置缩放等参数
	- 将其缩放都置为1，修改相机缩放为4.6
	- 背景地图可以不变，仍为2，同时描边加到3
	- 移动相关参数也需要重写
	- 存在抖动问题
		- 相机无法解决
		- 插值无法解决
		- 怀疑是rotation代码问题
	- 好困，先睡觉了
- 移动：参数调整，优化了水和水中戴夫的沉浮效果以及文件架构优化
- 移动：抖动问题，还未解决
	- 发现一个bug:入水后的一小段时间内仍可跳跃
	- 重命名了戴夫
	- 增加了一个停止move功能的导出变量
	- 明确是相机的问题了
	- 之后将尝试幻影相机
- 相机：添加幻影相机插件
	- 遗憾的是，这对我们的抖动问题并没有帮助，或许是我不会用
	- 此外，如何避免插件的内容出现在我们的实例化场景的名单中呢？
	- 或许，我应该回到缩放地图的路上
- 相机：修复失败
	- 把人物碰撞体改为了胶囊，或许之后会用上
	- 幻影相机暂时不用
	- 其他相机参数有调整，但都没啥效果，今天先这样吧，实在不行就不搞相机缩放了，还是地图缩放吧……

## 10/02

- 文件：架构重构与英文命名
	- 新增了一个Common文件夹，用来存储可通用的游戏模块，包括着色器等
	- 在场景文件夹中新增实体文件夹（戴夫僵尸植物等）、方法文件夹（移动寻路等），地图文件夹单独列出不作实体文件夹
	- 将大量文件名改为英文命名
- 寻路：找下坠点；连点成线；点生成优化
	- 美术：将显示点的大小改为0.25
	- 找到了下坠点，但颜色不好分辨
	- 常规平台上的连线已经搞定，但“水”上生成点，这方面怎么处理还需要思考
	- 修改点的生成条件为上面两格都得为空
- 寻路：基本框架解决
	- 修复BUG:在既是左边缘又是右边缘的情况下，下坠点的连线只会连接左边
		- 原版就有的bug了
		- 改完，给Fall点的寻找加了一个左右方向，以适应生成和连线不同的情况
	- 新的BUG：对于不可达的地区（上面的空只有一格），应当视作边缘，横向连线时应当不经过该区域
		- 这涉及到对“边缘”概念的更新。同时，这次新增的边缘也是等效原版“wall”边缘
		- 也涉及到对横向连线的特殊化处理

## 10/03

- 寻路：修复BUG与重构思考
	- 能否利用好新增的方向变量呢？
		- 这是个大工程，今晚肯定不好搞，但可以作为重构的方向
	- 修复BUG：对于不可达的地区（上面的空只有一格），应当视作边缘，横向连线时应当不经过该区域
		- 边缘点的生成已经搞定，新增了一个isTileWall函数来判断某个图块是否算墙
			- 这里默认寻路的僵尸算作两格，如有更改，可以重构TileTwoAboveEmpty函数和该函数以调整wall的判断
		- 莫名实现了“横向连线时应当不经过该区域”
			- 这两个点就没有进入过HorizontalConnectionCannotBeMade函数
			- 还需要进一步的判断，不过目前效果是可行的
- 寻路：BUG机制探明与彻底修复
	- 之前生效的原因在于左右两个点不是坠落点，所以连不起来
	- 还是要在HorizontalConnectionCannotBeMade中加入一些判断
- 寻路：给出路径功能完成
	- 重构了“寻找下坠点”的函数，使之可以单独使用
	- 改变了之前connect_points时的设置，即不再设置单向的线
	- 与原版相比，现在的GetPointInfoAtPosition函数的作用是找到起点和终点的落到平台上的点
		- 如果玩家在空中，而追逐者已经到了下面来了，那么就让追逐者跳跃即可
	- 可能的问题：会有重复的点，可能会造成一些bug，但现在还没有实际测试，不好修改
	- 寻路的“找点连线给路径”部分基本完成，下一步就是对这一部分的重构了，包括各种重命名什么的
		- 在这之前，尽量多参考参考《整洁代码》
- 相机：缩放问题解决
	- [参考](https://forum.godotengine.org/t/pixel-art-jittering/75305/13)
	- 关闭rendering/2d/snap/snap_2d_transforms_to_pixel和rendering/2d/snap/snap_2d_vertices_to_pixel即可
	- 此外保持物理插值、缩放模式等设置，还有一个相机位置的归整化没有设置，这是因为未来可能要用到幻影相机，且暂时不影响使用，就先放着了

## 10/04 

- 参数：修改了画面表现、人物移动等方面的参数
	- 水动画距离调为1.2
	- 相机缩放改为4.7倍同时取消整数倍缩放限制
	- 窗口大小：1516*844
	- 戴夫整体缩小为0.9倍
	- 移动：
		- 人物二段跳位移削减
		- 人物跳跃距离缩减
			- 跳跃参数需要计算，要知道：单次跳跃最大高度，上升/下落时间——从而修改重力等属性
			- 暂时不搞这个计算
		- 水中的移动很不对劲，这可能不是调整参数能解决的问题
		- 等待之后对移动函数的重构吧
- 寻路：重构代码
	- 命名：改为GD的命名方式
	- 增加新的导出变量——“单位格子数”，其实就是身高。本游戏默认为2格，包括小鬼。同时重构了判断格子有效的函数。
	- 基本重构了辅助函数的命名和一些局部和脚本内变量的命令。
		- 一些逻辑上的重构就需要明天再干了

## 10/05

- 寻路：重构代码
	- 将对vector2的具体数值都换成常量
	- 继续重命名函数与变量
	- 重构了找点和连线函数，代价是点的颜色不丰富了
	- 尝试搞懂get_plaform_2d_path函数的逻辑，并修改出现重复的点的bug
		- 这个等会干，已经修改的够多了，先提交一次
- 寻路：修复路径重复与首尾点不正确的问题
	- 修复路径重复问题
		- 给结尾点判断要不要压栈时加了一个等号
		- 如果最后一点与倒数第二点的距离 大于或等于 终点与倒数第二点的距离，就不把最后一点压入堆栈
	- 发现并解决新问题——首尾点不正确：
		- get_bottom_point_info_by_position函数的效果是找到最下面的平台上的一个点，这与我们的需求其实有偏差
		- 我们要的应该是一个y与平台上的点一致，但x跟着物体的点
		- 修改该函数返回新点时给新点的坐标为Vector2i(pos.x,map_to_local(fall_cell).y)
		- 可能并不需要判断点是否已存在,并且position也不需要Vector2i，这个之后再看吧
	- 以及main中的测试函数也得到了更新
- 重构PointInfo类，主要是重命名各种变量
	- ctrl+F，无敌
	- is_position_point属性感觉没有什么用，先保留着吧

## 10/06

- 移动代码重构：偏转、墙壁检测、变量
	- 删去“气球”相关代码，暂时不作该设计
	- 去掉@onready中的image变量，改为从char_body中获取。
		- 这导致char_body必须要有一个image，但尚可接受。
	- 将一些变量抽出来（char_rotation_degrees），避免总是调用char_body
	- 将偏转的逻辑抽离出来
		- 还没有完全搞明白毁灭菇对偏转的影响
		- 目前的策略是玩家的偏转由移动速度决定
	- 将wall_check的射线加到四个，不再调整其翻转
- 相机：修复了碰撞时全屏抖动的问题
	- 开启相机拖动即可
	- 同时清理了main中的测试代码
	- 以及一些相机参数设置，包括拖动的边框比例，平滑移动速度改为6
- 移动：重构水中相关物理效果等
	- 注意到：如果是在陆上但又检测到水，玩家依然可以跳跃，哪怕之后进入水中也可正常跳跃
		- 可见is_on_floor的刷新优先级是高于刚进入水时的清零的
	- 单独开了一个test-move的脚本避免修改大失败
	- 修复了“水”中的物理效果
		— 原因在于position = position.round()!这将导致小位移被忽略！
	- 下一步：
		- 调整横向移动的效果，优化短按的效果
		- 使之适应寻路：
			- 敌人寻路时，发现下一个点在左边，就调用向左移动的函数。向上，就调用向上的函数。
			- 这些函数中再根据具体状态进行实际的物理效果。
		- 参数调整

## 10/07

- 移动：重构竖向移动函数等
	- 现在，竖向移动函数已经和input分开了
	- move_by_input函数：专给戴夫等需要input才主动移动的实体
	- 给move脚本一个全局类名——Move
	- 删除test_move脚本
- 移动：沉浮功能与横移手感优化
	- 新加一个can-float变量，如果此不为true，就会沉入水底
		- 请注意，目前在水底会识别为地板从而刷新其跳跃次数等操作，所以建议结合can-move使用（比如“水草”）
		- 同时，潜水僵尸在水底就是按正常陆地走路的，所以可以用can_float来控制他的行动
	- 优化了横移手感
		- 减少了横移小跳的高度，使之更频繁
		- 设置横移计时器为one-shot，避免落地时一顿一顿的
		- 个人觉得，原版不是直接控制速度，而是给予加速度
			- 下一步就是尝试从这方面入手优化
- 移动：优化横移代码和参数等
	- 横移优化
		- 简直一模一样！
		- 横移的小跳改为有横向速度就跳
		- 删除了之前种种的辅助变量和计时器节点
	- 其他移动优化
		- 入水初始速度改为 min(water_init_speed,char_velocity.y)
		- 新增一个move-factor，暂时用来处理水对横移的影响，但其实效果不好扩展
			- 特别是不同运动受不同的因素影响
			- 如何处理冰冻状态呢？其他状态如何对移动造成影响呢？
	- 参数优化：跳跃、横移速度、加速度等
- 移动：代码小优化，将move保存为场景
- 僵尸：新建char-body与其他配置
	- 注意到，戴夫的图层在僵尸的下面
	- 同时需要构建一个碰撞层体系来安排好僵尸、植物、戴夫的位置
		- 目前已有：普通世界、梯子、水、绝对的壁垒（没有使用过）
	- 之后可能还是需要修改move脚本乃至改变他的工作方式来实现寻路，至少要有一个自己的move功能模块来处理一些事情

## 10/08

- 寻路：僵尸寻路与文件架构更新
	- 如何处理不同的寻路偏好呢？
		- 比如潜水僵尸在水中就有很多偏好
		- 索敌机制要不要单独拆出来比较好
	- 更新文件架构
		- 把僵尸等实体的寻路放在EntityPathFinder文件夹下
	- 寻路：规避坠落点识别错位的问题
		- 在获取实体对应的cell时，将其纵坐标加上一些，这样既不影响空中使用，也不会因为偏差导致将坠落点识别为下面一格
	- 我觉得不要急着动工，还是多想一想比较好
		- 同时伴随的还有敌人AI等问题，这需要进一步的思考哈
